FROM ubuntu:20.04

ARG DEBIAN_FRONTEND=noninteractive

RUN apt update && \
    apt install -y gcc xinetd nginx && \
    rm -rf /var/lib/apt/lists/*

WORKDIR /home/ctfuser

COPY vuln.c .
COPY flag.txt .
COPY index.html .


RUN gcc vuln.c -o vuln -fno-stack-protector -no-pie && chmod +x vuln


RUN rm -rf /var/www/html/* && cp index.html /var/www/html/index.html
RUN sed -i 's/listen 80 default_server;/listen 9017 default_server;/' /etc/nginx/sites-enabled/default


RUN echo "service level07\n\
{\n\
    disable     = no\n\
    type        = UNLISTED\n\
    port        = 8002\n\
    socket_type = stream\n\
    protocol    = tcp\n\
    wait        = no\n\
    user        = root\n\
    server      = /home/ctfuser/vuln\n\
}\n" > /etc/xinetd.d/level07


EXPOSE 9017 8002

CMD service nginx start && service xinetd start && tail -f /dev/null
